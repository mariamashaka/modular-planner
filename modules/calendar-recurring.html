<!DOCTYPE html> 
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .navigation {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .nav-btn {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover {
            background: #5f4fcf;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .working-version {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #edf2f7;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
        }

        .section-count {
            background: #38a169;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d3748;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-input:focus {
            outline: none;
            border-color: #38a169;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }

        .form-select:focus {
            outline: none;
            border-color: #38a169;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #38a169;
            color: white;
        }

        .btn-primary:hover {
            background: #2f855a;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-secondary {
            background: #6c5ce7;
            color: white;
        }

        .btn-secondary:hover {
            background: #5f4fcf;
        }

        .recurring-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #38a169;
            transition: all 0.3s ease;
        }

        .recurring-item:hover {
            background: #f0fff4;
            border-left-color: #2f855a;
        }

        .recurring-item.paused {
            border-left-color: #ed8936;
            background: #fffaf0;
        }

        .recurring-title {
            font-size: 1.1em;
            color: #2d3748;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .recurring-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .recurring-schedule {
            background: #e6fffa;
            color: #38a169;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .recurring-next {
            background: #fef5e7;
            color: #dd6b20;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .recurring-project {
            background: #e0e6ff;
            color: #6c5ce7;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .recurring-status {
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .recurring-status.paused {
            background: #fed7d7;
            color: #c53030;
        }

        .recurring-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            color: #718096;
            padding: 40px;
            font-style: italic;
        }

        .stats {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #4a5568;
            font-size: 0.9em;
        }

        .recurrence-preview {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .preview-title {
            font-weight: bold;
            color: #38a169;
            margin-bottom: 10px;
        }

        .preview-dates {
            color: #2d3748;
            font-size: 0.9em;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-row-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navigation">
    <!-- –°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß -->
    <div style="margin-bottom: 10px; font-weight: bold;">–°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß:</div>
    <a href="urgent-flow.html" class="nav-btn">‚ö° –°—Ä–æ—á–Ω—ã–µ</a>
    <a href="repeat-flow.html" class="nav-btn">üîÑ –ü–æ–≤—Ç–æ—Ä—ã</a>
    <a href="calendar-recurring.html" class="nav-btn">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ</a>
    <a href="projects-flow.html" class="nav-btn">üéØ –ü—Ä–æ–µ–∫—Ç—ã</a>
    
    <!-- –ö–û–õ–õ–ï–ö–¢–û–†–´ -->
    <div style="margin: 15px 0 5px 0; font-weight: bold;">–ö–û–õ–õ–ï–ö–¢–û–†–´:</div>
    <a href="day-planner.html" class="nav-btn">üì± –ü–ª–∞–Ω –¥–Ω—è</a>
    <a href="archive-viewer.html" class="nav-btn">üìä –ê—Ä—Ö–∏–≤</a>
    
    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div style="margin: 15px 0 5px 0; font-weight: bold;">–ù–ê–°–¢–†–û–ô–ö–ò:</div>
    <a href="category-manager.html" class="nav-btn">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
</div>

        <div class="header">
            <h1>üîÑ –ö–ê–õ–ï–ù–î–ê–†–ù–´–ï –ü–û–í–¢–û–†–Ø–Æ–©–ò–ï–°–Ø</h1>
            <p>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –¥–∞—Ç–∞–º</p>
        </div>

        <div class="working-version">
            üîß WORKING: calendar-recurring v1.0
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalRecurring">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–∞–≤–∏–ª</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeRecurring">0</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="upcomingWeek">0</div>
                    <div class="stat-label">–ù–∞ –Ω–µ–¥–µ–ª—é</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="upcomingMonth">0</div>
                    <div class="stat-label">–ù–∞ –º–µ—Å—è—Ü</div>
                </div>
            </div>
        </div>

 <!-- –ö–ù–û–ü–ö–ê –ü–ï–†–ï–•–û–î–ê –ö –ö–ê–õ–ï–ù–î–ê–†–ù–´–ú –ó–ê–î–ê–ß–ê–ú -->
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="calendar-instances.html" style="text-decoration: none;">
                <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); 
                            color: white; 
                            padding: 20px 30px; 
                            border-radius: 15px; 
                            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            font-size: 1.3em;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: inline-block;"
                     onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">
                    üìã –ü–û–°–ú–û–¢–†–ï–¢–¨ –ö–ê–õ–ï–ù–î–ê–†–ù–´–ï –ó–ê–î–ê–ß–ò
                    <div style="font-size: 0.7em; margin-top: 5px; opacity: 0.9;">
                        (–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å, –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–¥–∞—á–∞–º–∏)
                    </div>
                </div>
            </a>
        </div>
        
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è —Å–æ–±—ã—Ç–∏—è -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">‚ûï –°–û–ó–î–ê–¢–¨ –ü–†–ê–í–ò–õ–û –ü–û–í–¢–û–†–ï–ù–ò–Ø</div>
            </div>

            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:</label>
                <input type="text" id="eventName" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫–∞–∑ –ª–µ–∫–∞—Ä—Å—Ç–≤ –≤ –∞–ø—Ç–µ–∫—É">
            </div>

            <div class="form-group">
                <label class="form-label">–¢–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:</label>
                <select id="recurrenceType" class="form-select" onchange="updateRecurrenceOptions()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                    <option value="monthly_date">–ö–∞–∂–¥–æ–≥–æ –• —á–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞</option>
                    <option value="weekly">–ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –¥–µ–Ω—å</option>
                    <option value="interval_days">–ö–∞–∂–¥—ã–µ –• –¥–Ω–µ–π</option>
                    <option value="quarterly">–ö–∞–∂–¥—ã–π –∫–≤–∞—Ä—Ç–∞–ª</option>
                    <option value="yearly">–ö–∞–∂–¥—ã–π –≥–æ–¥</option>
                </select>
            </div>

            <!-- –û–ø—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è -->
            <div id="monthlyOptions" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–ß–∏—Å–ª–æ –º–µ—Å—è—Ü–∞:</label>
                        <select id="monthlyDate" class="form-select">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–∏—Å–ª–æ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–í—Ä–µ–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <input type="time" id="monthlyTime" class="form-input">
                    </div>
                </div>
            </div>

            <div id="weeklyOptions" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</label>
                        <select id="weeklyDay" class="form-select">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</option>
                            <option value="1">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
                            <option value="2">–í—Ç–æ—Ä–Ω–∏–∫</option>
                            <option value="3">–°—Ä–µ–¥–∞</option>
                            <option value="4">–ß–µ—Ç–≤–µ—Ä–≥</option>
                            <option value="5">–ü—è—Ç–Ω–∏—Ü–∞</option>
                            <option value="6">–°—É–±–±–æ—Ç–∞</option>
                            <option value="0">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–í—Ä–µ–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <input type="time" id="weeklyTime" class="form-input">
                    </div>
                </div>
            </div>

            <div id="intervalOptions" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–ö–∞–∂–¥—ã–µ (–¥–Ω–µ–π):</label>
                        <input type="number" id="intervalDays" class="form-input" min="1" max="365" placeholder="7">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ù–∞—á–∞—Ç—å —Å:</label>
                        <input type="date" id="intervalStart" class="form-input">
                    </div>
                </div>
            </div>

            <div id="quarterlyOptions" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–ß–∏—Å–ª–æ –∫–≤–∞—Ä—Ç–∞–ª–∞:</label>
                        <select id="quarterlyDate" class="form-select">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–∏—Å–ª–æ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ù–∞—á–∞—Ç—å —Å –∫–≤–∞—Ä—Ç–∞–ª–∞:</label>
                        <select id="quarterlyStart" class="form-select">
                            <option value="1">Q1 (—è–Ω–≤-–º–∞—Ä)</option>
                            <option value="2">Q2 (–∞–ø—Ä-–∏—é–Ω)</option>
                            <option value="3">Q3 (–∏—é–ª-—Å–µ–Ω)</option>
                            <option value="4">Q4 (–æ–∫—Ç-–¥–µ–∫)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="yearlyOptions" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞:</label>
                        <input type="date" id="yearlyDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–í—Ä–µ–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <input type="time" id="yearlyTime" class="form-input">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">–ü—Ä–æ–µ–∫—Ç:</label>
                <select id="eventProject" class="form-select">
                    <option value="">–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" id="eventDescription" class="form-input" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
            </div>

            <!-- –ü—Ä–µ–≤—å—é —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞—Ç -->
            <div id="recurrencePreview" style="display: none;">
                <div class="recurrence-preview">
                    <div class="preview-title">üìÖ –°–ª–µ–¥—É—é—â–∏–µ –¥–∞—Ç—ã —Å–æ–±—ã—Ç–∏—è:</div>
                    <div class="preview-dates" id="previewDates"></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; align-items: center; margin-top: 20px;">
                <button onclick="previewRecurrence()" class="btn btn-secondary">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞—Ç</button>
                <button onclick="addRecurringEvent()" class="btn btn-primary">üîÑ –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">üìã –ü–†–ê–í–ò–õ–ê –ü–û–í–¢–û–†–ï–ù–ò–Ø</div>
                <div class="section-count" id="recurringCount">0</div>
            </div>
            <div id="recurringList">
                <div class="empty-state">–ü–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º—ã -->
    <script src="../shared/projects.js"></script>
    <script src="../shared/archive.js"></script>
    <script>
        let recurringEvents = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== –ö–ê–õ–ï–ù–î–ê–†–ù–´–ï –ü–û–í–¢–û–†–Ø–Æ–©–ò–ï–°–Ø –ó–ê–ì–†–£–ñ–ê–Æ–¢–°–Ø ===');
            loadRecurringEvents();
            loadProjects();
            populateDateSelects();
            renderRecurringEvents();
            updateStats();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π
        function loadRecurringEvents() {
            try {
                const stored = localStorage.getItem('recurringEvents');
                recurringEvents = stored ? JSON.parse(stored) : [];
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∞–≤–∏–ª:', recurringEvents.length);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π:', error);
                recurringEvents = [];
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π
        function saveRecurringEvents() {
            try {
                localStorage.setItem('recurringEvents', JSON.stringify(recurringEvents));
                console.log('–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
        function loadProjects() {
            try {
                if (typeof window.ProjectsManager !== 'undefined') {
                    window.ProjectsManager.init();
                    const projects = window.ProjectsManager.getActive();
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–µ–∫—Ç—ã:', projects);
                    
                    const eventSelect = document.getElementById('eventProject');
                    eventSelect.innerHTML = '<option value="">–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞</option>';
                    projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.name;
                        option.textContent = project.name;
                        eventSelect.appendChild(option);
                    });
                } else {
                    console.error('ProjectsManager –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
            }
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ–≤ —Å —á–∏—Å–ª–∞–º–∏
        function populateDateSelects() {
            const monthlySelect = document.getElementById('monthlyDate');
            const quarterlySelect = document.getElementById('quarterlyDate');
            
            // –ß–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + ' —á–∏—Å–ª–æ';
                monthlySelect.appendChild(option);
            }
            
            // –ß–∏—Å–ª–∞ –∫–≤–∞—Ä—Ç–∞–ª–∞
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + ' —á–∏—Å–ª–æ';
                quarterlySelect.appendChild(option);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
        function updateRecurrenceOptions() {
            const type = document.getElementById('recurrenceType').value;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏
            document.getElementById('monthlyOptions').style.display = 'none';
            document.getElementById('weeklyOptions').style.display = 'none';
            document.getElementById('intervalOptions').style.display = 'none';
            document.getElementById('quarterlyOptions').style.display = 'none';
            document.getElementById('yearlyOptions').style.display = 'none';
            document.getElementById('recurrencePreview').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –æ–ø—Ü–∏–∏
            if (type === 'monthly_date') {
                document.getElementById('monthlyOptions').style.display = 'block';
            } else if (type === 'weekly') {
                document.getElementById('weeklyOptions').style.display = 'block';
            } else if (type === 'interval_days') {
                document.getElementById('intervalOptions').style.display = 'block';
                document.getElementById('intervalStart').value = new Date().toISOString().split('T')[0];
            } else if (type === 'quarterly') {
                document.getElementById('quarterlyOptions').style.display = 'block';
            } else if (type === 'yearly') {
                document.getElementById('yearlyOptions').style.display = 'block';
                document.getElementById('yearlyDate').value = new Date().toISOString().split('T')[0];
            }
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞—Ç
        function previewRecurrence() {
            const type = document.getElementById('recurrenceType').value;
            if (!type) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è!');
                return;
            }

            const nextDates = generateNextDates(type, 10); // –°–ª–µ–¥—É—é—â–∏–µ 10 –¥–∞—Ç
            if (nextDates.length > 0) {
                document.getElementById('previewDates').innerHTML = nextDates
                    .map(date => formatDate(date))
                    .join('<br>');
                document.getElementById('recurrencePreview').style.display = 'block';
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.');
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞—Ç
        function generateNextDates(type, count = 10) {
            const dates = [];
            const today = new Date();
            
            try {
                if (type === 'monthly_date') {
                    const date = parseInt(document.getElementById('monthlyDate').value);
                    if (!date) return [];
                    
                    for (let i = 0; i < count; i++) {
                        const nextDate = new Date(today.getFullYear(), today.getMonth() + i, date);
                        if (nextDate >= today) {
                            dates.push(nextDate);
                        }
                    }
                } else if (type === 'weekly') {
                    const dayOfWeek = parseInt(document.getElementById('weeklyDay').value);
                    if (isNaN(dayOfWeek)) return [];
                    
                    let current = new Date(today);
                    while (dates.length < count) {
                        if (current.getDay() === dayOfWeek && current >= today) {
                            dates.push(new Date(current));
                        }
                        current.setDate(current.getDate() + 1);
                        
                        // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
                        if (current.getTime() - today.getTime() > 365 * 24 * 60 * 60 * 1000) break;
                    }
                } else if (type === 'interval_days') {
                    const interval = parseInt(document.getElementById('intervalDays').value);
                    const startDate = new Date(document.getElementById('intervalStart').value);
                    if (!interval || !startDate) return [];
                    
                    let current = new Date(startDate);
                    while (dates.length < count) {
                        if (current >= today) {
                            dates.push(new Date(current));
                        }
                        current.setDate(current.getDate() + interval);
                    }
                } else if (type === 'yearly') {
                    const yearlyDate = new Date(document.getElementById('yearlyDate').value);
                    if (!yearlyDate) return [];
                    
                    for (let i = 0; i < count; i++) {
                        const nextDate = new Date(today.getFullYear() + i, yearlyDate.getMonth(), yearlyDate.getDate());
                        if (nextDate >= today) {
                            dates.push(nextDate);
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞—Ç:', error);
            }
            
            return dates.slice(0, count);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è —Å–æ–±—ã—Ç–∏—è
        function addRecurringEvent() {
            const name = document.getElementById('eventName').value.trim();
            const type = document.getElementById('recurrenceType').value;
            const project = document.getElementById('eventProject').value;
            const description = document.getElementById('eventDescription').value.trim();

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è!');
                return;
            }

            if (!type) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è!');
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            let recurrenceConfig = { type };
            
            if (type === 'monthly_date') {
                const date = document.getElementById('monthlyDate').value;
                const time = document.getElementById('monthlyTime').value;
                if (!date) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞!');
                    return;
                }
                recurrenceConfig.date = parseInt(date);
                recurrenceConfig.time = time || null;
            } else if (type === 'weekly') {
                const day = document.getElementById('weeklyDay').value;
                const time = document.getElementById('weeklyTime').value;
                if (!day) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏!');
                    return;
                }
                recurrenceConfig.dayOfWeek = parseInt(day);
                recurrenceConfig.time = time || null;
            } else if (type === 'interval_days') {
                const interval = document.getElementById('intervalDays').value;
                const start = document.getElementById('intervalStart').value;
                if (!interval || !start) {
                    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞!');
                    return;
                }
                recurrenceConfig.interval = parseInt(interval);
                recurrenceConfig.startDate = start;
            } else if (type === 'yearly') {
                const date = document.getElementById('yearlyDate').value;
                const time = document.getElementById('yearlyTime').value;
                if (!date) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É!');
                    return;
                }
                recurrenceConfig.date = date;
                recurrenceConfig.time = time || null;
            }

            const newRecurring = {
                id: Date.now(),
                name: name,
                recurrence: recurrenceConfig,
                project: project || null,
                description: description || null,
                active: true,
                createdAt: new Date().toISOString()
            };

            recurringEvents.push(newRecurring);
            saveRecurringEvents();

            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            clearForm();

            renderRecurringEvents();
            updateStats();
            
            alert('–ü—Ä–∞–≤–∏–ª–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–æ!');
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        function clearForm() {
            document.getElementById('eventName').value = '';
            document.getElementById('recurrenceType').value = '';
            document.getElementById('eventProject').value = '';
            document.getElementById('eventDescription').value = '';
            updateRecurrenceOptions();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π
        function renderRecurringEvents() {
            const container = document.getElementById('recurringList');
            
            if (recurringEvents.length === 0) {
                container.innerHTML = '<div class="empty-state">–ü–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                document.getElementById('recurringCount').textContent = '0';
                return;
            }

            const html = recurringEvents.map(event => {
                const scheduleText = getScheduleText(event.recurrence);
                const nextDate = getNextOccurrence(event);
                const nextDateText = nextDate ? formatDate(nextDate) : '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';

                return `
                    <div class="recurring-item ${event.active ? '' : 'paused'}">
                        <div class="recurring-title">${event.name}</div>
                        <div class="recurring-meta">
                            <span class="recurring-schedule">${scheduleText}</span>
                            <span class="recurring-next">–°–ª–µ–¥—É—é—â–∏–π: ${nextDateText}</span>
                            ${event.project ? `<span class="recurring-project">üìÅ ${event.project}</span>` : ''}
                            <span class="recurring-status ${event.active ? '' : 'paused'}">${event.active ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}</span>
                        </div>
                        ${event.description ? `<div style="color: #4a5568; font-size: 0.9em; margin-bottom: 10px;">${event.description}</div>` : ''}
                        <div class="recurring-actions">
                            ${event.active ? 
                                `<button onclick="pauseRecurring(${event.id})" class="btn btn-secondary">‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>` :
                                `<button onclick="resumeRecurring(${event.id})" class="btn btn-success">‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å</button>`
                            }
                            <button onclick="editRecurring(${event.id})" class="btn btn-secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button onclick="deleteRecurring(${event.id})" class="btn btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            document.getElementById('recurringCount').textContent = recurringEvents.length;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        function getScheduleText(recurrence) {
            const { type } = recurrence;
            
            if (type === 'monthly_date') {
                const timeText = recurrence.time ? ` –≤ ${recurrence.time}` : '';
                return `${recurrence.date} —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞${timeText}`;
            } else if (type === 'weekly') {
                const days = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
                const timeText = recurrence.time ? ` –≤ ${recurrence.time}` : '';
                return `–ö–∞–∂–¥—ã–π ${days[recurrence.dayOfWeek]}${timeText}`;
            } else if (type === 'interval_days') {
                return `–ö–∞–∂–¥—ã–µ ${recurrence.interval} –¥–Ω–µ–π`;
            } else if (type === 'quarterly') {
                return `${recurrence.date} —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –∫–≤–∞—Ä—Ç–∞–ª–∞`;
            } else if (type === 'yearly') {
                const date = new Date(recurrence.date);
                const timeText = recurrence.time ? ` –≤ ${recurrence.time}` : '';
                return `${date.getDate()} ${date.toLocaleDateString('ru-RU', { month: 'long' })} –∫–∞–∂–¥—ã–π –≥–æ–¥${timeText}`;
            }
            
            return '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ';
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è
        function getNextOccurrence(event) {
            const { recurrence } = event;
            const today = new Date();
            
            try {
                if (recurrence.type === 'monthly_date') {
                    // –°–ª–µ–¥—É—é—â–µ–µ —á–∏—Å–ª–æ —ç—Ç–æ–≥–æ –∏–ª–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                    let nextDate = new Date(today.getFullYear(), today.getMonth(), recurrence.date);
                    if (nextDate <= today) {
                        nextDate = new Date(today.getFullYear(), today.getMonth() + 1, recurrence.date);
                    }
                    return nextDate;
                } else if (recurrence.type === 'weekly') {
                    // –°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
                    let current = new Date(today);
                    current.setDate(current.getDate() + 1); // –ù–∞—á–∏–Ω–∞–µ–º —Å –∑–∞–≤—Ç—Ä–∞
                    
                    for (let i = 0; i < 7; i++) {
                        if (current.getDay() === recurrence.dayOfWeek) {
                            return current;
                        }
                        current.setDate(current.getDate() + 1);
                    }
                } else if (recurrence.type === 'interval_days') {
                    // –°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É
                    const startDate = new Date(recurrence.startDate);
                    let current = new Date(startDate);
                    
                    while (current <= today) {
                        current.setDate(current.getDate() + recurrence.interval);
                    }
                    return current;
                } else if (recurrence.type === 'yearly') {
                    // –°–ª–µ–¥—É—é—â–∏–π –≥–æ–¥ —ç—Ç–æ–π –∂–µ –¥–∞—Ç—ã
                    const date = new Date(recurrence.date);
                    let nextDate = new Date(today.getFullYear(), date.getMonth(), date.getDate());
                    if (nextDate <= today) {
                        nextDate = new Date(today.getFullYear() + 1, date.getMonth(), date.getDate());
                    }
                    return nextDate;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è:', error);
            }
            
            return null;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(date) {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const dateStr = date.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            if (dateStr === todayStr) {
                return '–°–µ–≥–æ–¥–Ω—è';
            } else if (dateStr === tomorrowStr) {
                return '–ó–∞–≤—Ç—Ä–∞';
            } else {
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'short',
                    year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
                });
            }
        }

        // –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª–∞
        function pauseRecurring(eventId) {
            const event = recurringEvents.find(e => e.id === eventId);
            if (event) {
                event.active = false;
                saveRecurringEvents();
                renderRecurringEvents();
                updateStats();
                alert('–ü—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            }
        }

        // –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
        function resumeRecurring(eventId) {
            const event = recurringEvents.find(e => e.id === eventId);
            if (event) {
                event.active = true;
                saveRecurringEvents();
                renderRecurringEvents();
                updateStats();
                alert('–ü—Ä–∞–≤–∏–ª–æ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–æ');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
        function deleteRecurring(eventId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è?')) return;

            recurringEvents = recurringEvents.filter(e => e.id !== eventId);
            saveRecurringEvents();
            renderRecurringEvents();
            updateStats();
            
            alert('–ü—Ä–∞–≤–∏–ª–æ —É–¥–∞–ª–µ–Ω–æ');
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        function editRecurring(eventId) {
            const event = recurringEvents.find(e => e.id === eventId);
            if (!event) return;

            const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', event.name);
            if (newName === null) return;

            if (newName.trim()) {
                event.name = newName.trim();
                saveRecurringEvents();
                renderRecurringEvents();
                alert('–ü—Ä–∞–≤–∏–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            const total = recurringEvents.length;
            const active = recurringEvents.filter(e => e.active).length;
            
            // –ü–æ–¥—Å—á–µ—Ç —Å–æ–±—ã—Ç–∏–π –Ω–∞ –Ω–µ–¥–µ–ª—é –∏ –º–µ—Å—è—Ü
            let upcomingWeek = 0;
            let upcomingMonth = 0;
            
            const today = new Date();
            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const monthFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            recurringEvents.forEach(event => {
                if (!event.active) return;
                
                const nextOccurrence = getNextOccurrence(event);
                if (nextOccurrence) {
                    if (nextOccurrence <= weekFromNow) {
                        upcomingWeek++;
                    }
                    if (nextOccurrence <= monthFromNow) {
                        upcomingMonth++;
                    }
                }
            });

            document.getElementById('totalRecurring').textContent = total;
            document.getElementById('activeRecurring').textContent = active;
            document.getElementById('upcomingWeek').textContent = upcomingWeek;
            document.getElementById('upcomingMonth').textContent = upcomingMonth;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É (–¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º)
        function getEventsForDate(targetDate) {
            const events = [];
            const target = new Date(targetDate);
            
            recurringEvents.forEach(event => {
                if (!event.active) return;
                
                const { recurrence } = event;
                let matches = false;
                
                if (recurrence.type === 'monthly_date') {
                    matches = target.getDate() === recurrence.date;
                } else if (recurrence.type === 'weekly') {
                    matches = target.getDay() === recurrence.dayOfWeek;
                } else if (recurrence.type === 'interval_days') {
                    const startDate = new Date(recurrence.startDate);
                    const diffTime = target.getTime() - startDate.getTime();
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    matches = diffDays >= 0 && diffDays % recurrence.interval === 0;
                } else if (recurrence.type === 'yearly') {
                    const recurDate = new Date(recurrence.date);
                    matches = target.getDate() === recurDate.getDate() && 
                             target.getMonth() === recurDate.getMonth();
                }
                
                if (matches) {
                    events.push({
                        ...event,
                        date: targetDate,
                        time: recurrence.time || null,
                        source: 'recurring'
                    });
                }
            });
            
            return events;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
        window.CalendarRecurring = {
            getEventsForDate: getEventsForDate,
            getAll: () => recurringEvents,
            getActive: () => recurringEvents.filter(e => e.active)
        };
    </script>
</body>
</html>
