<!DOCTYPE html> 
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            color: #333;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .filters-section {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .filters-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }
        
        .filter-input, .filter-select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .filter-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .filter-btn:hover {
            background: #218838;
        }
        
        .clear-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .archive-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            color: #495057;
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .task-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .task-item:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .task-text {
            font-size: 1.1rem;
            color: #333;
            font-weight: 500;
        }
        
        .task-time {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .task-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .task-project {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .project-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .task-module {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .task-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .btn-restore {
            background: #28a745;
            color: white;
        }
        
        .btn-restore:hover {
            background: #218838;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 50px;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
        }
        
        .nav-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 10px;
            transition: background 0.3s ease;
        }
        
        .nav-button:hover {
            background: #5a6fd8;
        }
        
        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <!-- 
    MODULE: Archive Viewer
    VERSION: 1.0
    STATUS: WORKING
    FEATURES: 
    - –ü—Ä–æ—Å–º–æ—Ç—Ä –∞—Ä—Ö–∏–≤–∞ –≤—Å–µ—Ö –∑–∞–¥–∞—á
    - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–µ, –ø—Ä–æ–µ–∫—Ç—É, –º–æ–¥—É–ª—é
    - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
    - –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∞—Ä—Ö–∏–≤–∞
    BUGS: none known
    -->
    
    <div class="container">
        <div class="header">
            <h1 class="title">üìä –ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</h1>
            <p class="subtitle">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid" id="statsGrid"></div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters-section">
            <div class="filters-row">
                <div class="filter-group">
                    <label class="filter-label">–ü–µ—Ä–∏–æ–¥:</label>
                    <select class="filter-select" id="periodFilter">
                        <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
                        <option value="month" selected>–ó–∞ –º–µ—Å—è—Ü</option>
                        <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">–ü—Ä–æ–µ–∫—Ç:</label>
                    <select class="filter-select" id="projectFilter">
                        <option value="">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">–ú–æ–¥—É–ª—å:</label>
                    <select class="filter-select" id="moduleFilter">
                        <option value="">–í—Å–µ –º–æ–¥—É–ª–∏</option>
                        <option value="urgent-flow">–°—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏</option>
                        <option value="repeat-flow">–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è</option>
                        <option value="calendar-flow">–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">–ü–æ–∏—Å–∫:</label>
                    <input type="text" class="filter-input" id="searchFilter" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏...">
                </div>
                <button class="filter-btn" onclick="applyFilters()">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
                <button class="clear-btn" onclick="clearFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="filter-btn" onclick="exportFullStatistics()" style="background: #dc3545; margin-left: 20px;">
                üìä –ü–û–õ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
                </button>
            </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á -->
        <div class="archive-section">
            <h2 class="section-title" id="sectionTitle">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
            <div id="archiveList"></div>
        </div>
        
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
       <div class="navigation">
    <!-- –°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß -->
    <div style="margin-bottom: 10px; font-weight: bold;">–°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß:</div>
    <a href="urgent-flow.html" class="nav-btn">‚ö° –°—Ä–æ—á–Ω—ã–µ</a>
    <a href="repeat-flow.html" class="nav-btn">üîÑ –ü–æ–≤—Ç–æ—Ä—ã</a>
    <a href="calendar-recurring.html" class="nav-btn">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ</a>
    <a href="projects-flow.html" class="nav-btn">üéØ –ü—Ä–æ–µ–∫—Ç—ã</a>
    
    <!-- –ö–û–õ–õ–ï–ö–¢–û–†–´ -->
    <div style="margin: 15px 0 5px 0; font-weight: bold;">–ö–û–õ–õ–ï–ö–¢–û–†–´:</div>
    <a href="day-planner.html" class="nav-btn">üì± –ü–ª–∞–Ω –¥–Ω—è</a>
    <a href="archive-viewer.html" class="nav-btn">üìä –ê—Ä—Ö–∏–≤</a>
    
    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div style="margin: 15px 0 5px 0; font-weight: bold;">–ù–ê–°–¢–†–û–ô–ö–ò:</div>
    <a href="category-manager.html" class="nav-btn">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
</div>
    </div>
    
    <div class="version-info">
        Archive Viewer v1.0 - –†–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è
    </div>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º—ã -->
    <script src="../shared/projects.js"></script>
    <script src="../shared/archive.js"></script>
    
    <script>
        let currentFilters = {};
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            ProjectsManager.init();
            ArchiveManager.init();
            
            loadProjectsToFilter();
            loadArchive();
            updateStats();
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä
        function loadProjectsToFilter() {
            const projects = ProjectsManager.getActive();
            const select = document.getElementById('projectFilter');
            
            select.innerHTML = `
                <option value="">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                ${projects.map(p => 
                    `<option value="${p.id}">${p.name}</option>`
                ).join('')}
            `;
        }
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters() {
            const period = document.getElementById('periodFilter').value;
            const projectId = document.getElementById('projectFilter').value;
            const moduleType = document.getElementById('moduleFilter').value;
            const searchText = document.getElementById('searchFilter').value;
            
            currentFilters = {
                period: period,
                projectId: projectId || undefined,
                moduleType: moduleType || undefined,
                searchText: searchText || undefined
            };
            
            loadArchive();
            updateStats();
        }
        
        // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function clearFilters() {
            document.getElementById('periodFilter').value = 'month';
            document.getElementById('projectFilter').value = '';
            document.getElementById('moduleFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            currentFilters = {};
            loadArchive();
            updateStats();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞
        function loadArchive() {
            let tasks;
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ –ø–æ –ø–µ—Ä–∏–æ–¥—É
            switch(currentFilters.period) {
                case 'today':
                    tasks = ArchiveManager.getToday();
                    break;
                case 'week':
                    tasks = ArchiveManager.getWeek();
                    break;
                case 'month':
                    tasks = ArchiveManager.getMonth();
                    break;
                default:
                    tasks = ArchiveManager.getAll();
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            if (currentFilters.projectId || currentFilters.moduleType || currentFilters.searchText) {
                tasks = ArchiveManager.getFiltered({
                    projectId: currentFilters.projectId,
                    moduleType: currentFilters.moduleType,
                    searchText: currentFilters.searchText
                }).filter(task => {
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥—É
                    if (currentFilters.period === 'today') {
                        const today = new Date().toISOString().split('T')[0];
                        return task.completedAt.startsWith(today);
                    }
                    if (currentFilters.period === 'week') {
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return new Date(task.completedAt) >= weekAgo;
                    }
                    if (currentFilters.period === 'month') {
                        const monthAgo = new Date();
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        return new Date(task.completedAt) >= monthAgo;
                    }
                    return true;
                });
            }
            
            renderArchive(tasks);
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞
        function renderArchive(tasks) {
            const container = document.getElementById('archiveList');
            const title = document.getElementById('sectionTitle');
            
            title.textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (${tasks.length})`;
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
                return;
            }
            
            container.innerHTML = tasks.map(task => {
                const projectInfo = getProjectInfo(task.projectId);
                const completedTime = formatDateTime(task.completedAt);
                
                return `
                    <div class="task-item">
                        <div class="task-header">
                            <div class="task-text">${task.text}</div>
                            <div class="task-time">${completedTime}</div>
                        </div>
                        <div class="task-meta">
                            <div class="task-project">
                                <span class="project-dot" style="background-color: ${projectInfo.color}"></span>
                                <span>${projectInfo.name}</span>
                            </div>
                            <div class="task-module">${getModuleName(task.moduleType)}</div>
                            ${task.originalDate ? `<span>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å: ${formatDate(task.originalDate)}</span>` : ''}
                        </div>
                        ${task.notes ? `<div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 8px;">${task.notes}</div>` : ''}
                        <div class="task-actions">
                            <button class="action-btn btn-restore" onclick="restoreTask('${task.id}')">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                            <button class="action-btn btn-delete" onclick="deleteTask('${task.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            const period = currentFilters.period || 'month';
            const stats = ArchiveManager.getStats(period);
            
            const statsContainer = document.getElementById('statsGrid');
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º
            const projectStats = Object.entries(stats.projectStats)
                .map(([projectId, count]) => {
                    const projectInfo = getProjectInfo(projectId === 'no-project' ? null : projectId);
                    return { name: projectInfo.name, count: count };
                })
                .sort((a, b) => b.count - a.count)
                .slice(0, 3); // –¢–æ–ø 3 –ø—Ä–æ–µ–∫—Ç–∞
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalTasks}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round(stats.averagePerDay * 10) / 10}</div>
                    <div class="stat-label">–í —Å—Ä–µ–¥–Ω–µ–º –≤ –¥–µ–Ω—å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.moduleStats['urgent-flow'] || 0}</div>
                    <div class="stat-label">–°—Ä–æ—á–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${projectStats[0]?.name || '-'}</div>
                    <div class="stat-label">–¢–æ–ø –ø—Ä–æ–µ–∫—Ç (${projectStats[0]?.count || 0})</div>
                </div>
            `;
        }
        
       // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ
function getProjectInfo(projectId) {
    if (!projectId) return { name: '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞', color: '#6c757d' };
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ ID
    let project = ProjectsManager.getById(projectId);
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ ID, –∏—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    if (!project) {
        const allProjects = ProjectsManager.getActive();
        project = allProjects.find(p => p.name === projectId);
    }
    
    return project ? 
        { name: project.name, color: project.color } : 
        { name: '–£–¥–∞–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç', color: '#dc3545' };
}
        
        // –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è
        function getModuleName(moduleType) {
            const names = {
                'urgent-flow': '–°—Ä–æ—á–Ω—ã–µ',
                'repeat-flow': '–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è',
                'calendar-flow': '–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ'
            };
            return names[moduleType] || moduleType;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
        function restoreTask(archiveId) {
            if (!confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É –∏–∑ –∞—Ä—Ö–∏–≤–∞?')) return;
            
            try {
                const restoredTask = ArchiveManager.restore(archiveId);
                alert(`–ó–∞–¥–∞—á–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –º–æ–¥—É–ª—å "${getModuleName(restoredTask.moduleType)}" —á—Ç–æ–±—ã –µ—ë —É–≤–∏–¥–µ—Ç—å.`);
                loadArchive();
                updateStats();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∞—Ä—Ö–∏–≤–∞ –Ω–∞–≤—Å–µ–≥–¥–∞
        function deleteTask(archiveId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –∏–∑ –∞—Ä—Ö–∏–≤–∞ –ù–ê–í–°–ï–ì–î–ê?')) return;
            
            try {
                ArchiveManager.delete(archiveId);
                loadArchive();
                updateStats();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function exportData() {
            try {
                const exportData = ArchiveManager.export(currentFilters);
                const blob = new Blob([exportData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `archive_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message);
            }
        }
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function goToMain() {
            alert('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É');
        }
        
        function goToUrgent() {
            window.location.href = 'urgent-flow.html';
        }
// ============================================
// –ü–û–õ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê v3.0 - –° PROJECTS-FLOW
// ============================================

function exportFullStatistics() {
    const periodFrom = prompt('–ü–µ—Ä–∏–æ–¥ –° (—Ñ–æ—Ä–º–∞—Ç: 2025-10-01):');
    const periodTo = prompt('–ü–µ—Ä–∏–æ–¥ –ü–û (—Ñ–æ—Ä–º–∞—Ç: 2025-10-31):');
    
    if (!periodFrom || !periodTo) {
        alert('–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –æ–±–∞ –ø–µ—Ä–∏–æ–¥–∞!');
        return;
    }
    
    try {
        const fullData = {
            export_info: {
                export_date: new Date().toISOString(),
                period_from: periodFrom,
                period_to: periodTo,
                exported_by: 'Modular Planner Statistics v3.0 - WITH PROJECTS-FLOW'
            },
            
            // 1. –ê–†–•–ò–í
            archive: getArchiveDataImproved(periodFrom, periodTo),
            
            // 2. –°–†–û–ß–ù–´–ï –ó–ê–î–ê–ß–ò
            urgent_tasks: getUrgentTasksDataImproved(periodFrom, periodTo),
            
            // 3. –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–´–ï –ü–£–õ–´
            repeat_pools: getRepeatPoolsDataImproved(periodFrom, periodTo),
            
            // 4. –ö–ê–¢–ï–ì–û–†–ò–ò (—Å—Ç–∞—Ä—ã–µ "projects")
            categories: getCategoriesData(periodFrom, periodTo),
            
            // 5. –†–ï–ê–õ–¨–ù–´–ï –ü–†–û–ï–ö–¢–´ (projectsFlow) - –ù–û–í–û–ï!
            projects_flow: getProjectsFlowData(periodFrom, periodTo),
            
            // 6. –ö–ê–õ–ï–ù–î–ê–†–¨
            calendar_events: getCalendarData(periodFrom, periodTo)
        };
        
        const blob = new Blob([JSON.stringify(fullData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `full_statistics_v3_${periodFrom}_to_${periodTo}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        
        alert('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ v3 –≤—ã–≥—Ä—É–∂–µ–Ω–∞!\n\nüÜï –î–æ–±–∞–≤–ª–µ–Ω–æ:\n‚Ä¢ –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã (projectsFlow)\n‚Ä¢ –≠—Ç–∞–ø—ã –∏ –ø–æ–¥–∑–∞–¥–∞—á–∏\n‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø—Ä–æ–µ–∫—Ç–æ–≤\n‚Ä¢ –°—Ç–∞—Ç—É—Å—ã (active/paused)\n‚Ä¢ –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞');
        
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error(error);
    }
}

// ============================================
// –§–£–ù–ö–¶–ò–ò –°–ë–û–†–ê –î–ê–ù–ù–´–•
// ============================================

// 1. –ê–†–•–ò–í
function getArchiveDataImproved(from, to) {
    const fromDate = new Date(from).toISOString();
    const toDate = new Date(to + 'T23:59:59').toISOString();
    
    const tasks = ArchiveManager.getFiltered({
        dateFrom: fromDate,
        dateTo: toDate
    });
    
    // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Å—Ä–æ—á–µ–∫
    const overdueAnalysis = tasks
        .filter(t => t.originalDate && t.moduleType === 'urgent-flow')
        .map(t => {
            const originalDate = new Date(t.originalDate);
            const completedDate = new Date(t.completedAt);
            const daysOverdue = Math.floor((completedDate - originalDate) / (1000 * 60 * 60 * 24));
            
            return {
                task: t.text,
                originalDate: t.originalDate,
                completedDate: t.completedAt.split('T')[0],
                daysOverdue: daysOverdue,
                priority: t.priority || '–Ω–µ —É–∫–∞–∑–∞–Ω',
                project: t.projectId || '–ë–ï–ó –ü–†–û–ï–ö–¢–ê'
            };
        })
        .filter(t => t.daysOverdue > 0)
        .sort((a, b) => b.daysOverdue - a.daysOverdue);
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
    const priorityStats = {
        '–≤—ã—Å–æ–∫–∏–π': 0,
        '—Å—Ä–µ–¥–Ω–∏–π': 0,
        '–Ω–∏–∑–∫–∏–π': 0,
        '–Ω–µ —É–∫–∞–∑–∞–Ω': 0
    };
    
    tasks.forEach(t => {
        const priority = t.priority || '–Ω–µ —É–∫–∞–∑–∞–Ω';
        if (priorityStats.hasOwnProperty(priority)) {
            priorityStats[priority]++;
        }
    });
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–æ–¥—É–ª—è–º
    const byModule = {
        'urgent-flow': tasks.filter(t => t.moduleType === 'urgent-flow'),
        'repeat-flow': tasks.filter(t => t.moduleType === 'repeat-flow'),
        'projects-flow': tasks.filter(t => t.moduleType === 'projects-flow'),
        'calendar-events': tasks.filter(t => t.moduleType === 'calendar-events')
    };
    
    return {
        total_completed: tasks.length,
        tasks: tasks,
        priority_stats: priorityStats,
        overdue_analysis: {
            total_overdue: overdueAnalysis.length,
            tasks: overdueAnalysis
        },
        by_module: {
            'urgent-flow': byModule['urgent-flow'].length,
            'repeat-flow': byModule['repeat-flow'].length,
            'projects-flow': byModule['projects-flow'].length,
            'calendar-events': byModule['calendar-events'].length
        },
        stats: ArchiveManager.getStats('all')
    };
}

// 2. –°–†–û–ß–ù–´–ï –ó–ê–î–ê–ß–ò
function getUrgentTasksDataImproved(from, to) {
    try {
        const urgentTasks = JSON.parse(localStorage.getItem('urgentTasks') || '[]');
        const fromDate = new Date(from);
        const toDate = new Date(to);
        
        const active = urgentTasks.filter(t => !t.completed);
        
        const today = new Date();
        const overdueActive = active.filter(t => {
            if (!t.date) return false;
            const taskDate = new Date(t.date);
            return taskDate < today;
        }).map(t => {
            const taskDate = new Date(t.date);
            const daysOverdue = Math.floor((today - taskDate) / (1000 * 60 * 60 * 24));
            return {
                ...t,
                daysOverdue: daysOverdue
            };
        }).sort((a, b) => b.daysOverdue - a.daysOverdue);
        
        const inPeriod = urgentTasks.filter(t => {
            if (!t.date) return false;
            const taskDate = new Date(t.date);
            return taskDate >= fromDate && taskDate <= toDate;
        });
        
        const activePriorityStats = {
            '–≤—ã—Å–æ–∫–∏–π': 0,
            '—Å—Ä–µ–¥–Ω–∏–π': 0,
            '–Ω–∏–∑–∫–∏–π': 0,
            '–Ω–µ —É–∫–∞–∑–∞–Ω': 0
        };
        
        active.forEach(t => {
            const priority = t.priority || '–Ω–µ —É–∫–∞–∑–∞–Ω';
            if (activePriorityStats.hasOwnProperty(priority)) {
                activePriorityStats[priority]++;
            }
        });
        
        return {
            active_now: active,
            active_count: active.length,
            active_priority_stats: activePriorityStats,
            overdue_active: overdueActive,
            overdue_active_count: overdueActive.length,
            tasks_in_period: inPeriod,
            total_in_period: inPeriod.length,
            note: '–ê–∫—Ç–∏–≤–Ω—ã–µ = –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Å–µ–π—á–∞—Å, –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ = –¥–µ–¥–ª–∞–π–Ω –ø—Ä–æ—à—ë–ª –Ω–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'
        };
    } catch (e) {
        return { error: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ä–æ—á–Ω—ã–º –∑–∞–¥–∞—á–∞–º' };
    }
}

// 3. –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–´–ï –ü–£–õ–´
function getRepeatPoolsDataImproved(from, to) {
    try {
        const repeatPools = JSON.parse(localStorage.getItem('repeatPools') || '[]');
        
        const poolsAnalysis = repeatPools.map(pool => {
            const tasks = pool.tasks || [];
            
            const tasksAnalysis = tasks.map(task => {
                const target = task.targetPerWeek || task.target || 0;
                const completed = task.completed || 0;
                const percentage = target > 0 ? Math.round((completed / target) * 100) : 0;
                
                return {
                    name: task.name,
                    target: target,
                    completed: completed,
                    percentage: percentage,
                    status: completed >= target ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' : 
                           completed > 0 ? '‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ' : '‚ùå –ù–µ –Ω–∞—á–∞—Ç–æ'
                };
            });
            
            const totalTarget = tasks.reduce((sum, t) => sum + (t.targetPerWeek || t.target || 0), 0);
            const totalCompleted = tasks.reduce((sum, t) => sum + (t.completed || 0), 0);
            const poolPercentage = totalTarget > 0 ? Math.round((totalCompleted / totalTarget) * 100) : 0;
            
            return {
                pool_name: pool.name,
                project: pool.project,
                color: pool.color,
                total_target: totalTarget,
                total_completed: totalCompleted,
                percentage: poolPercentage,
                tasks: tasksAnalysis,
                weekKey: tasks[0]?.weekKey || 'unknown'
            };
        });
        
        return {
            pools: repeatPools,
            pools_analysis: poolsAnalysis,
            total_pools: repeatPools.length,
            note: 'percentage = % –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–µ–ª–∏ –∑–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é'
        };
    } catch (e) {
        return { error: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º—Å—è –∑–∞–¥–∞—á–∞–º' };
    }
}

// 4. –ö–ê–¢–ï–ì–û–†–ò–ò (—Å—Ç–∞—Ä—ã–µ "projects")
function getCategoriesData(from, to) {
    try {
        const projects = ProjectsManager.getActive();
        const fromDate = new Date(from).toISOString();
        const toDate = new Date(to + 'T23:59:59').toISOString();
        
        const projectsWithActivity = projects.map(project => {
            const completedTasks = ArchiveManager.getFiltered({
                projectId: project.id,
                dateFrom: fromDate,
                dateTo: toDate
            });
            
            const completedTasksByName = ArchiveManager.getFiltered({
                projectId: project.name,
                dateFrom: fromDate,
                dateTo: toDate
            });
            
            const allCompleted = [...completedTasks, ...completedTasksByName];
            const uniqueCompleted = Array.from(new Set(allCompleted.map(t => t.id)))
                .map(id => allCompleted.find(t => t.id === id));
            
            let lastActivity = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
            if (uniqueCompleted.length > 0) {
                const dates = uniqueCompleted.map(t => new Date(t.completedAt));
                const lastDate = new Date(Math.max(...dates));
                lastActivity = lastDate.toISOString().split('T')[0];
            }
            
            return {
                ...project,
                completed_in_period: uniqueCompleted.length,
                last_activity: lastActivity,
                completed_tasks_details: uniqueCompleted.map(t => ({
                    text: t.text,
                    completedAt: t.completedAt.split('T')[0],
                    moduleType: t.moduleType
                }))
            };
        });
        
        projectsWithActivity.sort((a, b) => b.completed_in_period - a.completed_in_period);
        
        return {
            categories: projectsWithActivity,
            total_categories: projects.length,
            active_categories: projectsWithActivity.filter(p => p.completed_in_period > 0).length,
            inactive_categories: projectsWithActivity.filter(p => p.completed_in_period === 0).length,
            note: '–≠—Ç–æ –ö–ê–¢–ï–ì–û–†–ò–ò (–Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–µ –ø—Ä–æ–µ–∫—Ç—ã), —Å–º. projects_flow –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤'
        };
    } catch (e) {
        return { error: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º' };
    }
}

// 5. –†–ï–ê–õ–¨–ù–´–ï –ü–†–û–ï–ö–¢–´ (projectsFlow) - –ù–û–í–û–ï!
function getProjectsFlowData(from, to) {
    try {
        const projectsFlow = JSON.parse(localStorage.getItem('projectsFlow') || '[]');
        const fromDate = new Date(from).toISOString();
        const toDate = new Date(to + 'T23:59:59').toISOString();
        
        const projectsAnalysis = projectsFlow.map(project => {
            // –ù–∞—Ö–æ–¥–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏–∑ –∞—Ä—Ö–∏–≤–∞
            const completedInArchive = ArchiveManager.getFiltered({
                projectId: project.name,
                dateFrom: fromDate,
                dateTo: toDate
            }).filter(t => t.moduleType === 'projects-flow');
            
            // –°—á–∏—Ç–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ (–ø–æ —ç—Ç–∞–ø–∞–º)
            let totalTasks = 0;
            let completedTasks = 0;
            let activeTasks = 0;
            let overdueCount = 0;
            
            const today = new Date();
            
            const stagesAnalysis = (project.stages || []).map(stage => {
                const subtasks = stage.subtasks || [];
                const stageCompleted = subtasks.filter(st => st.completed).length;
                const stageActive = subtasks.filter(st => !st.completed).length;
                
                // –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø–æ–¥–∑–∞–¥–∞—á–∏
                const stageOverdue = subtasks.filter(st => {
                    if (st.completed) return false;
                    
                    if (st.dateType === 'deadline' && st.deadline) {
                        return new Date(st.deadline) < today;
                    }
                    if (st.dateType === 'timeframe' && st.endDate) {
                        return new Date(st.endDate) < today;
                    }
                    return false;
                }).length;
                
                totalTasks += subtasks.length;
                completedTasks += stageCompleted;
                activeTasks += stageActive;
                overdueCount += stageOverdue;
                
                return {
                    stage_name: stage.name,
                    stage_deadline: stage.deadline || '–Ω–µ —É–∫–∞–∑–∞–Ω',
                    stage_completed: stage.completed || false,
                    total_subtasks: subtasks.length,
                    completed_subtasks: stageCompleted,
                    active_subtasks: stageActive,
                    overdue_subtasks: stageOverdue,
                    percentage: subtasks.length > 0 ? Math.round((stageCompleted / subtasks.length) * 100) : 0,
                    subtasks_details: subtasks.map(st => ({
                        name: st.name,
                        completed: st.completed || false,
                        dateType: st.dateType || 'someday',
                        deadline: st.deadline || null,
                        startDate: st.startDate || null,
                        endDate: st.endDate || null,
                        createdAt: st.createdAt || null
                    }))
                };
            });
            
            // –û–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
            const projectPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ —Å–∞–º–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            let projectOverdue = false;
            if (project.dateType === 'deadline' && project.deadline) {
                projectOverdue = new Date(project.deadline) < today;
            } else if (project.dateType === 'timeframe' && project.endDate) {
                projectOverdue = new Date(project.endDate) < today;
            }
            
            return {
                project_name: project.name,
                description: project.description || '',
                priority: project.priority || '–Ω–µ —É–∫–∞–∑–∞–Ω',
                status: project.status || 'unknown',
                dateType: project.dateType || 'someday',
                deadline: project.deadline || null,
                startDate: project.startDate || null,
                endDate: project.endDate || null,
                created_at: project.createdAt || null,
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                total_tasks: totalTasks,
                completed_tasks: completedTasks,
                active_tasks: activeTasks,
                overdue_tasks: overdueCount,
                percentage: projectPercentage,
                project_overdue: projectOverdue,
                
                // –í—ã–ø–æ–ª–Ω–µ–Ω–æ –≤ –ø–µ—Ä–∏–æ–¥–µ (–∏–∑ –∞—Ä—Ö–∏–≤–∞)
                completed_in_period: completedInArchive.length,
                completed_in_period_details: completedInArchive.map(t => ({
                    text: t.text,
                    completedAt: t.completedAt.split('T')[0]
                })),
                
                // –î–µ—Ç–∞–ª–∏ —ç—Ç–∞–ø–æ–≤
                stages: stagesAnalysis,
                total_stages: (project.stages || []).length
            };
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (1 = —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π)
        projectsAnalysis.sort((a, b) => {
            const priorityA = typeof a.priority === 'number' ? a.priority : 999;
            const priorityB = typeof b.priority === 'number' ? b.priority : 999;
            return priorityA - priorityB;
        });
        
        return {
            projects: projectsAnalysis,
            total_projects: projectsFlow.length,
            summary: {
                active: projectsAnalysis.filter(p => p.status === 'active').length,
                paused: projectsAnalysis.filter(p => p.status === 'paused').length,
                completed: projectsAnalysis.filter(p => p.percentage === 100).length,
                overdue: projectsAnalysis.filter(p => p.project_overdue).length,
                total_tasks: projectsAnalysis.reduce((sum, p) => sum + p.total_tasks, 0),
                total_completed: projectsAnalysis.reduce((sum, p) => sum + p.completed_tasks, 0)
            },
            note: '–≠–¢–û –†–ï–ê–õ–¨–ù–´–ï –ü–†–û–ï–ö–¢–´ –∏–∑ projects-flow (Code.Task manager, Pediatric calculator –∏ —Ç.–¥.)'
        };
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è projectsFlow:', e);
        return { error: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º (projectsFlow): ' + e.message };
    }
}

// 6. –ö–ê–õ–ï–ù–î–ê–†–¨
function getCalendarData(from, to) {
    try {
        const calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
        const fromDate = new Date(from);
        const toDate = new Date(to);
        
        const eventsInPeriod = calendarEvents.filter(e => {
            const eventDate = new Date(e.date);
            return eventDate >= fromDate && eventDate <= toDate;
        });
        
        return {
            events_in_period: eventsInPeriod,
            total: eventsInPeriod.length
        };
    } catch (e) {
        return { error: '–ù–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö' };
    }
}
    </script>
</body>
</html>
